<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Mitch’s Auto Services – Book a Service</title>
  <style>
    :root {
      --orange: #f47a1f;
      --orange-dark: #d9650e;
      --bg-top: #4a4a4a;
      --bg-bottom: #060606;
      --text: #ffffff;
      --muted: rgba(255,255,255,0.75);
      --border: rgba(255,255,255,0.25);
      --error: #ffb4b4;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: var(--text);
      background: linear-gradient(180deg, var(--bg-top), var(--bg-bottom));
      min-height: 100vh;
    }
    .site-banner {
      background: #000;
      color: #fff;
      text-align: center;
      padding: 18px 16px;
      font-size: 1.75rem;
      font-weight: 800;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }
    .site-banner__title {
      margin: 0;
    }
    a { color: inherit; }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 32px 20px 48px;
    }
    .brand-intro {
      display: flex;
      align-items: center;
      gap: 18px;
    }
    .brand-copy {
      flex: 1;
    }
    header.topbar {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 24px;
    }
    header.topbar h1 {
      margin: 0 0 8px;
      font-size: 2.4rem;
    }
    header.topbar p {
      margin: 0;
      color: var(--muted);
      font-size: 1rem;
    }
    .coverage {
      max-width: 360px;
      margin-left: auto;
      background: rgba(0, 0, 0, 0.55);
      border: 1px solid rgba(255, 255, 255, 0.35);
      border-radius: 18px;
      padding: 18px 20px;
      box-shadow: 0 16px 32px rgba(0, 0, 0, 0.35);
      font-weight: 600;
      color: var(--text);
    }
    .coverage p {
      margin: 0 0 10px;
      color: rgba(255,255,255,0.9);
    }
    .coverage p:last-child {
      margin-bottom: 0;
    }
    .coverage .contact {
      font-weight: 700;
    }
    .modes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
      margin-bottom: 26px;
    }
    .mode-card {
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.35);
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 10px 24px rgba(0,0,0,0.25);
    }
    .mode-card h3 {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 1.2rem;
    }
    .mode-card p {
      margin: 0;
      color: rgba(255,255,255,0.85);
      line-height: 1.45;
    }
    .card {
      background: var(--orange);
      border: 2px solid var(--orange-dark);
      border-radius: 18px;
      padding: 24px;
      margin-bottom: 26px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.35);
    }
    .card h2 {
      margin-top: 0;
      margin-bottom: 12px;
      font-size: 1.8rem;
    }
    label {
      font-weight: 700;
      display: block;
      margin-bottom: 6px;
    }
    input, button, select, textarea {
      font-size: 1rem;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.35);
      color: var(--text);
      width: 100%;
    }
    input::placeholder { color: rgba(255,255,255,0.6); }
    button {
      background: var(--orange-dark);
      border: 1px solid rgba(255,255,255,0.35);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease;
    }
    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 6px 18px rgba(0,0,0,0.35);
    }
    button:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }
    .hint {
      font-size: 0.9rem;
      color: rgba(255,255,255,0.85);
      margin-top: 6px;
    }
    .alert {
      margin-top: 14px;
      padding: 12px 14px;
      border-radius: 12px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(0,0,0,0.4);
      font-weight: 600;
    }
    .alert.error {
      color: #250000;
      background: rgba(255,215,215,0.8);
      border-color: rgba(255,255,255,0.5);
    }
    .alert.warn {
      background: rgba(0,0,0,0.45);
      border-color: rgba(255,255,255,0.5);
    }
    .result {
      margin-top: 20px;
      border-top: 1px solid rgba(255,255,255,0.35);
      padding-top: 18px;
    }
    .grid-two {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
    }
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }
    .address-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin-top: 8px;
    }
    .full-width {
      grid-column: 1 / -1;
    }
    .service-list {
      display: grid;
      gap: 16px;
      margin-top: 18px;
    }
    .service-item {
      background: rgba(0,0,0,0.35);
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.35);
      padding: 18px;
      display: block;
      cursor: pointer;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      position: relative;
    }
    .service-item.expanded {
      border-color: var(--text);
      box-shadow: 0 10px 28px rgba(0,0,0,0.4);
    }
    .service-summary {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
    }
    .service-summary h3 {
      margin: 0 0 6px;
      font-size: 1.25rem;
    }
    .service-meta {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-weight: 600;
    }
    .service-meta .price {
      font-size: 1.1rem;
    }
    .applicable-tag {
      font-size: 0.85rem;
      color: rgba(255,255,255,0.85);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .service-controls {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .service-item input[type="radio"] {
      width: auto;
      transform: scale(1.1);
    }
    .chevron {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      font-size: 0.85rem;
      transition: transform 0.2s ease;
    }
    .service-item.expanded .chevron {
      transform: rotate(180deg);
    }
    .service-body {
      display: none;
      margin-top: 14px;
      padding: 16px;
      border-radius: 12px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.2);
      color: rgba(255,255,255,0.9);
      line-height: 1.5;
    }
    .service-item.expanded .service-body {
      display: block;
    }
    .service-overview {
      margin: 0 0 10px;
    }
    .service-suitability {
      margin: 0;
      font-weight: 600;
    }
    .service-section {
      margin-top: 12px;
    }
    .service-section h4 {
      margin: 0 0 6px;
      font-size: 1rem;
    }
    .service-section ul {
      margin: 0;
      padding-left: 20px;
    }
    .service-section li {
      margin-bottom: 6px;
    }
    .service-note {
      margin: 12px 0 0;
      font-weight: 600;
    }
    .mode-select-wrapper {
      display: none;
      margin-top: 16px;
    }
    .mode-select-description {
      margin-top: 12px;
      padding: 16px;
      border-radius: 12px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.2);
      color: rgba(255,255,255,0.9);
      line-height: 1.5;
    }
    .mode-list {
      display: grid;
      gap: 16px;
      margin-top: 16px;
    }
    .mode-item {
      background: rgba(0,0,0,0.35);
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.35);
      padding: 18px;
      cursor: pointer;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      position: relative;
    }
    .mode-item.expanded {
      border-color: var(--text);
      box-shadow: 0 10px 28px rgba(0,0,0,0.4);
    }
    .mode-summary {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
    }
    .mode-summary h4 {
      margin: 0 0 4px;
      font-size: 1.2rem;
    }
    .mode-tag {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.35);
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .mode-controls {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .mode-item input[type="radio"] {
      width: auto;
      transform: scale(1.1);
    }
    .mode-body {
      display: none;
      margin-top: 14px;
      padding: 16px;
      border-radius: 12px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.2);
      color: rgba(255,255,255,0.9);
      line-height: 1.5;
    }
    .mode-item.expanded .mode-body {
      display: block;
    }
    .option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      border-radius: 12px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.35);
      margin-bottom: 10px;
    }
    .option input[type="radio"] {
      width: auto;
    }
    .hidden { display: none !important; }
    .info-callout {
      padding: 12px 14px;
      border-radius: 12px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.35);
      line-height: 1.45;
    }
    .footer-note {
      margin-top: 14px;
      font-size: 0.95rem;
      color: rgba(255,255,255,0.85);
    }
    @media (max-width: 640px) {
      header.topbar {
        text-align: center;
      }
      .brand-intro {
        flex-direction: column;
        align-items: flex-start;
      }
      .coverage {
        text-align: center;
        margin-left: 0;
      }
      .service-summary {
        flex-direction: column;
        align-items: flex-start;
      }
      .mode-summary {
        flex-direction: column;
        align-items: flex-start;
      }
      .service-controls {
        width: 100%;
        justify-content: space-between;
      }
      .mode-controls {
        width: 100%;
        justify-content: space-between;
      }
      button {
        width: 100%;
      }
      .mode-select-wrapper {
        display: block;
      }
      .mode-list {
        display: none;
      }
    }
  </style>
</head>
<body>
  <header class="site-banner">
    <div class="site-banner__title">Mitchs Auto Services</div>
  </header>
  <div class="container">
    <header class="topbar">
      <div class="brand-intro">
        <div class="brand-copy">
          <h1>Mitch’s Auto Services</h1>
          <p>Trusted mobile and garage mechanic support — our loyalty programme even gives you a chance to win a free service.</p>
          <div class="brand-intro__steps">
            <p>
              Welcome to Mitch’s Auto Services booking page. To make a booking, simply enter your vehicle registration number so we can
              identify your car. Next, you’ll:
            </p>
            <ul>
              <li>Choose a service tailored to your vehicle</li>
              <li>Select a warranty option (6 months standard, upgrades available)</li>
              <li>Pick a date and time that suits you best</li>
              <li>Provide your details — name, address, email, and contact number</li>
            </ul>
            <p>
              IF YOU’RE NOT SURE WHAT’S WRONG YOU CAN EITHER BOOK A DIAGNOSTIC, OR CHOOSE THE “I DON’T KNOW” OPTION IN THE SERVICE LIST
              AND GIVE US AS MUCH DETAIL AS YOU CAN. WE’LL REVIEW IT AND GET BACK TO YOU WITH THE NEXT STEPS AS QUICKLY AS POSSIBLE.
            </p>
            <p>Once submitted, we’ll confirm your booking and send you all the details by email.</p>
          </div>
        </div>
      </div>
      <div class="coverage">
        <p>We work within a 15 mile radius from Unit 5, Wingate Grange Industrial Estate, TS28 5AH.</p>
        <p>Anything further is £25 for call out.</p>
        <p>Bookings available between 9am and 5pm.</p>
        <p class="contact">Call or WhatsApp: <a href="tel:07926725369">07926725369</a></p>
        <p>Email: <a href="mailto:support@mitchsautoservices.co.uk">support@mitchsautoservices.co.uk</a></p>
      </div>
    </header>

    <div class="modes-grid">
      <div class="mode-card">
        <h3>Mobile service</h3>
        <p>Our fully equipped van brings the workshop to your driveway or workplace, perfect for servicing, diagnostics, battery work and brake repairs without the travel hassle.</p>
      </div>
      <div class="mode-card">
        <h3>Garage service</h3>
        <p>Drop the car with us at Unit 5 for pit access, larger repairs and longer jobs. We keep you updated throughout and get you back on the road quickly.</p>
      </div>
    </div>

    <section class="card">
      <h2>Check your vehicle</h2>
      <form id="vrmForm" onsubmit="event.preventDefault(); lookupVRM();" class="grid-two">
        <div>
          <label for="vrm">Vehicle Registration (Reg)</label>
          <input id="vrm" name="vrm" placeholder="Enter your registration" maxlength="8" autocomplete="off" required>
          <div class="hint">We don’t do electric cars right now.</div>
        </div>
        <div style="align-self: end;">
          <button id="lookupBtn" type="submit">Look up</button>
        </div>
      </form>
      <div id="error" class="alert error hidden"></div>

      <div id="vehicleCard" class="result hidden">
        <h3 id="vehTitle"></h3>
        <p id="vehMeta"></p>
        <p id="vehReg"></p>
        <p id="evNotice" class="alert warn hidden"></p>
        <div class="grid-two">
          <div>
            <strong>MOT:</strong>
            <div id="motStatus"></div>
          </div>
          <div>
            <strong>Tax:</strong>
            <div id="taxStatus"></div>
          </div>
        </div>
      </div>

    </section>

    <section id="servicesCard" class="card hidden">
      <h2>Select a service</h2>
      <p>Once we've confirmed your vehicle, tap a service to open the full description, see what's included and check the typical symptoms.</p>
      <p class="hint">We carry out both mobile and garage work depending on what suits you best.</p>
      <div id="servicesMessage" class="alert warn hidden"></div>
      <div id="serviceList" class="service-list"></div>
      <div id="warrantySection" class="hidden" style="margin-top:24px;">
        <h3>Warranty options</h3>
        <p class="hint">My standard (free) warranty is 6 months. Upgrade for longer cover.</p>
        <label class="option"><input type="radio" name="warr" value="6 months (included)" checked> 6 Months (included)</label>
        <label class="option"><input type="radio" name="warr" value="12 months (+£20)"> 1 Year for £20</label>
        <label class="option"><input type="radio" name="warr" value="18 months (+£40)"> 1 Year 6 Months for £40</label>
        <label class="option"><input type="radio" name="warr" value="Lifetime (price on request)"> Lifetime warranty (price on request – depends on make & model)</label>
      </div>
      <div id="fulfilmentSection" class="hidden" style="margin-top:24px;">
        <h3>How would you like us to carry out the work?</h3>
        <p class="hint">Choose the style that suits you — appointments run between 9am and 5pm in 30-minute slots.</p>
        <div class="mode-select-wrapper">
          <label for="modeSelect">Choose your service style</label>
          <select id="modeSelect" name="modeSelect">
            <option value="">Select service style</option>
            <option value="mobile" data-value="Mobile mechanic visit" data-label="Mobile mechanic visit">Mobile mechanic — we come to you</option>
            <option value="garage" data-value="Garage drop-off" data-label="Garage drop-off service">Garage service — drop off with us</option>
          </select>
          <div id="modeSelectDescription" class="mode-select-description hidden"></div>
        </div>
        <div class="mode-list">
          <label class="mode-item" data-mode="mobile">
            <div class="mode-summary">
              <div>
                <h4>Mobile mechanic</h4>
                <span class="mode-tag">We come to you</span>
              </div>
              <div class="mode-controls">
                <span class="chevron" aria-hidden="true">&#9662;</span>
                <input type="radio" name="mode" value="Mobile mechanic visit" data-label="Mobile mechanic visit">
              </div>
            </div>
            <div class="mode-body">
              <p>With this option you are requesting one of our mechanics to come to your address. Perfect for keeping life easy on servicing, diagnostics, brake work and battery care without needing to travel.</p>
            </div>
          </label>
          <label class="mode-item" data-mode="garage">
            <div class="mode-summary">
              <div>
                <h4>Garage service</h4>
                <span class="mode-tag">Drop off with us</span>
              </div>
              <div class="mode-controls">
                <span class="chevron" aria-hidden="true">&#9662;</span>
                <input type="radio" name="mode" value="Garage drop-off" data-label="Garage drop-off service">
              </div>
            </div>
            <div class="mode-body">
              <p>With this option you choose to bring your vehicle to the garage and drop it off. Ideal when the job needs pit access, longer workshop time or when it suits you to leave the car with us.</p>
            </div>
          </label>
        </div>
      </div>
      <div id="bookingSection" class="hidden" style="margin-top:24px;">
        <h3>Select a date and time</h3>
        <p class="hint">Pick a day from today onwards and choose a 30-minute slot between 09:00 and 17:00 that works for you.</p>
        <div class="grid-two">
          <div>
            <label for="appointmentDate">Preferred date</label>
            <input type="date" id="appointmentDate" name="appointmentDate">
          </div>
          <div>
            <label for="appointmentTime">Preferred time</label>
            <select id="appointmentTime" name="appointmentTime">
              <option value="">Select a time</option>
              <option value="09:00">09:00</option>
              <option value="09:30">09:30</option>
              <option value="10:00">10:00</option>
              <option value="10:30">10:30</option>
              <option value="11:00">11:00</option>
              <option value="11:30">11:30</option>
              <option value="12:00">12:00</option>
              <option value="12:30">12:30</option>
              <option value="13:00">13:00</option>
              <option value="13:30">13:30</option>
              <option value="14:00">14:00</option>
              <option value="14:30">14:30</option>
              <option value="15:00">15:00</option>
              <option value="15:30">15:30</option>
              <option value="16:00">16:00</option>
              <option value="16:30">16:30</option>
              <option value="17:00">17:00</option>
            </select>
          </div>
        </div>
        <div id="infoSection" class="hidden" style="margin-top:24px;">
          <h3>Your details</h3>
          <p class="hint">Please share your contact information so we can confirm the booking with you.</p>
          <div class="info-grid">
            <div>
              <label for="firstName">First name</label>
              <input id="firstName" name="firstName" autocomplete="given-name" placeholder="First name">
            </div>
            <div>
              <label for="lastName">Last name</label>
              <input id="lastName" name="lastName" autocomplete="family-name" placeholder="Last name">
            </div>
            <div>
              <label for="emailAddress">Email address</label>
              <input id="emailAddress" name="emailAddress" type="email" autocomplete="email" placeholder="name@example.com">
            </div>
            <div>
              <label for="phoneNumber">Phone number</label>
              <input id="phoneNumber" name="phoneNumber" type="tel" autocomplete="tel" placeholder="07...">
            </div>
            <div id="mobileAddressGroup" class="full-width hidden">
              <label for="serviceAddressLine1">Service address</label>
              <div class="address-grid">
                <div>
                  <input id="serviceAddressLine1" name="serviceAddressLine1" autocomplete="address-line1" placeholder="Street address">
                </div>
                <div>
                  <input id="serviceAddressLine2" name="serviceAddressLine2" autocomplete="address-line2" placeholder="Apartment, suite, etc (optional)">
                </div>
                <div>
                  <input id="serviceCity" name="serviceCity" autocomplete="address-level2" placeholder="City">
                </div>
                <div>
                  <input id="servicePostcode" name="servicePostcode" autocomplete="postal-code" placeholder="Postcode">
                </div>
              </div>
              <div class="hint">Include the postcode so we can plan our visit.</div>
            </div>
            <div id="garageAddressNotice" class="full-width hidden">
              <label>Garage drop-off location</label>
              <div class="info-callout">Unit 5, Wingate Grange Industrial Estate, TS28 5AH</div>
            </div>
            <div class="full-width">
              <label for="extraComments">Extra comments</label>
              <textarea id="extraComments" name="extraComments" rows="4" placeholder="Let us know anything else about your vehicle or the booking"></textarea>
            </div>
          </div>
        </div>
      </div>
      <div style="margin-top:24px;" id="finishContainer" class="hidden">
        <button id="finishBtn" onclick="finishBooking()">Finish</button>
        <p class="footer-note">Tap Finish to send us an email with everything we need at <a href="mailto:support@mitchsautoservices.co.uk">support@mitchsautoservices.co.uk</a>.</p>
      </div>
    </section>
  </div>

  <script>
    const API_URL = '/api/vrm';
    const DVLA_FALLBACK_URL = 'https://driver-vehicle-licensing.api.gov.uk/vehicle-enquiry/v1/vehicles';
    const DVLA_FALLBACK_KEY = 'ZQHFV22Ym6ao1CfyyqEol2oxzpoWQM2w59rAkPro';
    const VEHICLE_NOT_FOUND_MESSAGE = 'We are unable to find your vehicle, please check you have entered the reg correctly.';
    const GARAGE_ADDRESS_TEXT = 'Unit 5, Wingate Grange Industrial Estate, TS28 5AH';

    const FULFILMENT_SECTION = document.getElementById('fulfilmentSection');
    const BOOKING_SECTION = document.getElementById('bookingSection');
    const DATE_INPUT = document.getElementById('appointmentDate');
    const TIME_INPUT = document.getElementById('appointmentTime');
    const MODE_ITEMS = Array.from(document.querySelectorAll('#fulfilmentSection .mode-item'));
    const MODE_SELECT = document.getElementById('modeSelect');
    const MODE_SELECT_DESCRIPTION = document.getElementById('modeSelectDescription');
    const MODE_DESCRIPTIONS = MODE_ITEMS.reduce((map, item) => {
      const key = item.dataset.mode;
      const body = item.querySelector('.mode-body');
      if (key && body) {
        map[key] = body.textContent.trim();
      }
      return map;
    }, {});
    const INFO_SECTION = document.getElementById('infoSection');
    const FIRST_NAME_INPUT = document.getElementById('firstName');
    const LAST_NAME_INPUT = document.getElementById('lastName');
    const EMAIL_INPUT = document.getElementById('emailAddress');
    const PHONE_INPUT = document.getElementById('phoneNumber');
    const SERVICE_ADDRESS_LINE1_INPUT = document.getElementById('serviceAddressLine1');
    const SERVICE_ADDRESS_LINE2_INPUT = document.getElementById('serviceAddressLine2');
    const SERVICE_CITY_INPUT = document.getElementById('serviceCity');
    const SERVICE_POSTCODE_INPUT = document.getElementById('servicePostcode');
    const MOBILE_ADDRESS_GROUP = document.getElementById('mobileAddressGroup');
    const GARAGE_ADDRESS_NOTICE = document.getElementById('garageAddressNotice');
    const EXTRA_COMMENTS_INPUT = document.getElementById('extraComments');

    function updateModeDescription(modeKey) {
      if (!MODE_SELECT_DESCRIPTION) {
        return;
      }
      if (modeKey && MODE_DESCRIPTIONS[modeKey]) {
        MODE_SELECT_DESCRIPTION.textContent = MODE_DESCRIPTIONS[modeKey];
        MODE_SELECT_DESCRIPTION.classList.remove('hidden');
      } else {
        MODE_SELECT_DESCRIPTION.textContent = '';
        MODE_SELECT_DESCRIPTION.classList.add('hidden');
      }
    }

    function handleModeChange(modeKey) {
      const addressInputs = [
        SERVICE_ADDRESS_LINE1_INPUT,
        SERVICE_ADDRESS_LINE2_INPUT,
        SERVICE_CITY_INPUT,
        SERVICE_POSTCODE_INPUT
      ];

      if (modeKey === 'mobile') {
        if (MOBILE_ADDRESS_GROUP) {
          MOBILE_ADDRESS_GROUP.classList.remove('hidden');
        }
        if (SERVICE_ADDRESS_LINE1_INPUT) {
          SERVICE_ADDRESS_LINE1_INPUT.required = true;
        }
        if (SERVICE_CITY_INPUT) {
          SERVICE_CITY_INPUT.required = true;
        }
        if (SERVICE_POSTCODE_INPUT) {
          SERVICE_POSTCODE_INPUT.required = true;
        }
        if (GARAGE_ADDRESS_NOTICE) {
          GARAGE_ADDRESS_NOTICE.classList.add('hidden');
        }
      } else if (modeKey === 'garage') {
        if (MOBILE_ADDRESS_GROUP) {
          MOBILE_ADDRESS_GROUP.classList.add('hidden');
        }
        addressInputs.forEach(input => {
          if (input) {
            input.required = false;
            input.value = '';
          }
        });
        if (GARAGE_ADDRESS_NOTICE) {
          GARAGE_ADDRESS_NOTICE.classList.remove('hidden');
        }
      } else {
        if (MOBILE_ADDRESS_GROUP) {
          MOBILE_ADDRESS_GROUP.classList.add('hidden');
        }
        addressInputs.forEach(input => {
          if (input) {
            input.required = false;
            input.value = '';
          }
        });
        if (GARAGE_ADDRESS_NOTICE) {
          GARAGE_ADDRESS_NOTICE.classList.add('hidden');
        }
      }
    }

    function resetCustomerForm() {
      if (FIRST_NAME_INPUT) FIRST_NAME_INPUT.value = '';
      if (LAST_NAME_INPUT) LAST_NAME_INPUT.value = '';
      if (EMAIL_INPUT) EMAIL_INPUT.value = '';
      if (PHONE_INPUT) PHONE_INPUT.value = '';
      if (EXTRA_COMMENTS_INPUT) EXTRA_COMMENTS_INPUT.value = '';
      [
        SERVICE_ADDRESS_LINE1_INPUT,
        SERVICE_ADDRESS_LINE2_INPUT,
        SERVICE_CITY_INPUT,
        SERVICE_POSTCODE_INPUT
      ].forEach(input => {
        if (input) {
          input.value = '';
          input.required = false;
        }
      });
      if (MOBILE_ADDRESS_GROUP) {
        MOBILE_ADDRESS_GROUP.classList.add('hidden');
      }
      if (GARAGE_ADDRESS_NOTICE) {
        GARAGE_ADDRESS_NOTICE.classList.add('hidden');
      }
      if (INFO_SECTION) {
        INFO_SECTION.classList.add('hidden');
      }
    }

    handleModeChange('');

    function setModeSelection(modeKey, options = {}) {
      const { expand = true } = options;
      const value = modeKey || '';

      MODE_ITEMS.forEach(item => {
        const match = Boolean(value) && item.dataset.mode === value;
        const radio = item.querySelector('input[name="mode"]');
        if (radio) {
          radio.checked = match;
        }
        if (expand) {
          item.classList.toggle('expanded', match);
        } else if (!match) {
          item.classList.remove('expanded');
        } else if (match) {
          item.classList.add('expanded');
        }
      });

      if (MODE_SELECT && MODE_SELECT.value !== value) {
        MODE_SELECT.value = value;
      }

      updateModeDescription(value);
      handleModeChange(value);
    }
    const ALLOWED_TIMES = [
      '09:00', '09:30', '10:00', '10:30', '11:00', '11:30',
      '12:00', '12:30', '13:00', '13:30', '14:00', '14:30',
      '15:00', '15:30', '16:00', '16:30', '17:00'
    ];

    if (TIME_INPUT) {
      const existingValues = new Set(Array.from(TIME_INPUT.options).map(option => option.value).filter(Boolean));
      ALLOWED_TIMES.forEach(time => {
        if (!existingValues.has(time)) {
          const option = document.createElement('option');
          option.value = time;
          option.textContent = time;
          TIME_INPUT.appendChild(option);
        }
      });
    }

    function refreshDateLimits() {
      if (!DATE_INPUT) {
        return;
      }
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const iso = today.toISOString().split('T')[0];
      DATE_INPUT.min = iso;
      if (DATE_INPUT.value && DATE_INPUT.value < iso) {
        DATE_INPUT.value = iso;
      }
    }

    refreshDateLimits();

    MODE_ITEMS.forEach(item => {
      const radio = item.querySelector('input[name="mode"]');
      const modeKey = item.dataset.mode;
      const handleSelect = () => {
        if (modeKey) {
          setModeSelection(modeKey, { expand: true });
        }
      };

      item.addEventListener('click', event => {
        if (event.target && event.target.matches('input[type="radio"]')) {
          return;
        }
        handleSelect();
      });

      if (radio) {
        radio.addEventListener('change', () => {
          if (radio.checked) {
            handleSelect();
          }
        });
      }
    });

    if (MODE_SELECT) {
      MODE_SELECT.addEventListener('change', () => {
        const value = MODE_SELECT.value;
        if (value) {
          setModeSelection(value, { expand: true });
        } else {
          setModeSelection('', { expand: false });
        }
      });
    }

    function resolveErrorMessage(value) {
      if (!value) {
        return '';
      }
      if (typeof value === 'string') {
        return value;
      }
      if (Array.isArray(value)) {
        const stringItem = value.find(item => typeof item === 'string');
        if (stringItem) {
          return stringItem;
        }
      }
      if (typeof value === 'object') {
        if (typeof value.message === 'string') {
          return value.message;
        }
        const firstString = Object.values(value).find(entry => typeof entry === 'string');
        if (firstString) {
          return firstString;
        }
      }
      return '';
    }

    const SERVICES = [
      {
        id: 'air_filter',
        title: 'Air Filter Replacement',
        price: 'From £80',
        applicable: ['Petrol', 'Diesel'],
        overview: 'A fresh air filter keeps the engine breathing freely so it can deliver proper power and fuel economy again.',
        includes: [
          'Remove the old air filter and inspect the air box for debris or damage',
          'Install an OEM-quality filter matched to your vehicle',
          'Clean the housing and check ducting and seals for leaks'
        ],
        symptoms: [
          'Sluggish acceleration or flat performance',
          'Rough idle or hesitation when pulling away',
          'Dirty or clogged filter element on inspection',
          'Noticeable drop in fuel economy or fumes from the intake'
        ]
      },
      {
        id: 'basic_service',
        title: 'Basic Service Package',
        price: 'From £100',
        applicable: ['Petrol', 'Diesel'],
        overview: 'The perfect service to reset the essentials and keep your daily driver running smoothly between major visits.',
        includes: [
          'Engine oil replacement',
          'Oil filter replacement',
          'Air filter replacement',
          'Dust/pollen filter replacement',
          'Coolant replacement',
          'Tyre pressure & tread inspection',
          'Headlights/rear lights inspection',
          'Battery inspection'
        ],
        symptoms: [
          'Overdue service reminder or warning light illuminated',
          'Engine oil that is dark, dirty or low on the dipstick',
          'Noisy running or the car feeling a bit tired',
          'Uneven tyre wear or poor fuel economy compared with normal'
        ]
      },
      {
        id: 'battery_replacement',
        title: 'Battery Replacement (includes recoding)',
        price: 'From £200',
        applicable: ['Petrol', 'Diesel'],
        overview: 'Modern batteries need the right setup so the smart charging system knows what has been fitted. We handle the heavy lifting and the coding.',
        includes: [
          'Battery health test and charging system check',
          'Supply and install the correct capacity replacement battery',
          'Code/register the new battery to the vehicle where required',
          'Verify starting and charging performance before handover'
        ],
        symptoms: [
          'Slow crank or clicking when starting the engine',
          'Needing repeated jump-starts or booster packs',
          'Random electrical faults or warning messages',
          'Battery or charging light showing on the dash'
        ]
      },
      {
        id: 'brake_change',
        title: 'Brake Change',
        price: 'From £100',
        applicable: ['Petrol', 'Diesel'],
        overview: 'Fresh pads and discs restore confident stopping power so you can brake smoothly and safely again.',
        includes: [
          'Inspect calipers, slides and brake hoses for wear or leaks',
          'Replace pads and discs on the affected axle with quality parts',
          'Clean and lubricate contact points so everything moves freely',
          'Road-test the vehicle to bed in the new brakes and verify performance'
        ],
        notes: 'Price covers both sides of the brake pads and discs on the axle serviced.',
        symptoms: [
          'Scraping, squeaking or grinding noises under braking',
          'Vibration through the pedal or steering wheel',
          'Longer stopping distances or a soft brake pedal',
          'Brake wear warning light or MOT advisories for pads/discs'
        ]
      },
      {
        id: 'brake_fluid',
        title: 'Brake Fluid Flush',
        price: 'From £70',
        applicable: ['Petrol', 'Diesel'],
        overview: 'Moisture-contaminated fluid boils quicker and gives you a spongy pedal. A flush restores a firm feel and keeps internal components protected.',
        includes: [
          'Check brake fluid moisture content and boiling point',
          'Flush the entire hydraulic system with fresh DOT-rated fluid',
          'Bleed each wheel circuit to remove trapped air',
          'Final pedal feel and ABS operation check'
        ],
        symptoms: [
          'Soft or spongy brake pedal feel',
          'Brake fade during longer stops or downhill driving',
          'ABS warning lights appearing intermittently',
          'Brake fluid older than 2 years or dark in colour'
        ]
      },
      {
        id: 'battery_recharge',
        title: 'Car Battery Recharge (overnight)',
        price: 'From £80',
        applicable: ['Petrol', 'Diesel'],
        overview: 'Slow, controlled charging brings tired batteries back to life and avoids over-stressing the cells.',
        includes: [
          'Remove and bench-test your battery',
          'Carry out an overnight slow charge with professional equipment',
          'Load-test and certify the recovered capacity',
          'Refit the battery and reset clock/windows as needed'
        ],
        symptoms: [
          'Hard starting after the car sits for a couple of days',
          'Low voltage readings or dim interior lights',
          'Doing short trips that never fully recharge the battery',
          'Battery warning appearing even after long drives'
        ]
      },
      {
        id: 'diagnostic',
        title: 'Car Diagnostic Check',
        price: 'From £50',
        applicable: ['Petrol', 'Diesel'],
        overview: 'If you are not sure what is wrong, this in-depth scan points you in the right direction with a full written report.',
        includes: [
          'Plug in professional diagnostics and read fault codes from all modules',
          'Live-data monitoring to spot intermittent or sensor-related issues',
          'Targeted electrical and mechanical checks based on findings',
          'Email you a transparent report with next-step recommendations'
        ],
        symptoms: [
          'Engine light or other dashboard warnings',
          'Misfires, cutting out or refusing to start',
          'Unusual noises, vibrations or smells',
          'Mystery electrical gremlins that appear and disappear'
        ]
      },
      {
        id: 'refresh',
        title: 'Car Refresh Service',
        price: 'From £600',
        applicable: ['Petrol', 'Diesel'],
        overview: 'A top-to-bottom rejuvenation that brings neglected or newly purchased cars back to their best.',
        includes: [
          'Engine oil replacement',
          'Oil filter replacement',
          'Air filter replacement',
          'Dust/pollen filter replacement',
          'Coolant replacement',
          'Spark plugs replacement (if needed)',
          'Brake pads (front & rear) replacement (if needed)',
          'Brake discs (front & rear) replacement (if needed)',
          'Tyre pressure & tread inspection',
          'Headlights/rear lights inspection',
          'Battery inspection',
          'Battery replacement',
          'Headlights/rear lights replacement'
        ],
        symptoms: [
          'Multiple overdue maintenance items or poor service history',
          'General tired running or noisy operation',
          'Preparing the car for sale or after purchasing a used vehicle',
          'Wanting maximum confidence before a long trip or big change of use'
        ]
      },
      {
        id: 'coolant',
        title: 'Coolant Change',
        price: 'From £80',
        applicable: ['Petrol', 'Diesel'],
        overview: 'Correct coolant protects your engine from overheating, corrosion and freezing damage.',
        includes: [
          'Drain the old coolant and safely dispose of it',
          'Flush the cooling system if needed to remove sludge and scale',
          'Refill with the correct antifreeze mix for your vehicle',
          'Bleed the system and verify heater performance'
        ],
        symptoms: [
          'Temperature gauge running high or fluctuating',
          'Sweet smells from the engine bay or visible coolant leaks',
          'Rusty, dirty or oily coolant in the expansion tank',
          'Coolant older than the recommended service interval'
        ]
      },
      {
        id: 'pollen',
        title: 'Dust/Pollen Filter Replacement',
        price: 'From £80',
        applicable: ['Petrol', 'Diesel'],
        overview: 'Breathe easier with clean cabin filters that keep smells and allergens at bay.',
        includes: [
          'Remove the old cabin filter and clean out debris',
          'Fit a fresh pollen filter matched to the vehicle',
          'Treat the ventilation box to prevent mould build-up',
          'Check blower motor operation and vent direction control'
        ],
        symptoms: [
          'Musty or damp smells through the vents',
          'Weak airflow even on higher fan speeds',
          'Allergies or sneezing worsening inside the car',
          'Noisy blower motor struggling to push air'
        ]
      },
      {
        id: 'oil',
        title: 'Engine Oil & Filter Change',
        price: 'From £60',
        applicable: ['Petrol', 'Diesel'],
        overview: 'Clean oil is the cheapest insurance against premature engine wear and noisy running.',
        includes: [
          'Drain the old engine oil and remove the filter',
          'Install a new quality filter and sump washer',
          'Fill with manufacturer-approved oil to the correct level',
          'Reset service indicators and inspect for leaks'
        ],
        symptoms: [
          'Engine sounding rougher or noisier than usual',
          'Service reminder illuminated on the dashboard',
          'Very dark or sludgy oil on the dipstick',
          'Ticking noises on cold starts or after hard driving'
        ]
      },
      {
        id: 'fuel_filter',
        title: 'Fuel Filter Replacement',
        price: 'From £50',
        applicable: ['Petrol', 'Diesel'],
        overview: 'Keeping the fuel clean protects injectors and pumps, especially on modern high-pressure systems.',
        includes: [
          'Depressurise the fuel system safely',
          'Swap out the fuel filter for a fresh unit',
          'Inspect fuel lines and fittings for leaks or corrosion',
          'Prime the system and verify leak-free operation'
        ],
        symptoms: [
          'Hesitation or stuttering when accelerating',
          'Poor fuel economy compared with normal',
          'Hard starting or extended cranking',
          'Engine stalling at junctions or under load'
        ]
      },
      {
        id: 'lights',
        title: 'Headlights & Rear Lights Replacement',
        price: 'From £60',
        applicable: ['Petrol', 'Diesel'],
        overview: 'Stay safe and legal with bright bulbs and working light units front and rear.',
        includes: [
          'Check which bulbs or units have failed and why',
          'Supply and fit quality replacements matched to your vehicle',
          'Clean lens covers and check for moisture ingress',
          'Test beam pattern, alignment and warning systems'
        ],
        symptoms: [
          'Dim, flickering or failed bulbs',
          'Warning lights on the dashboard for exterior lamps',
          'Poor night visibility or other drivers flashing you',
          'MOT advisories for lights or reflectors'
        ]
      },
      {
        id: 'major_service',
        title: 'Major Service Package',
        price: 'From £350',
        applicable: ['Petrol', 'Diesel'],
        overview: 'Our most in-depth scheduled service covers every key fluid and wear item so you can reset the maintenance clock.',
        includes: [
          'Engine oil replacement',
          'Oil filter replacement',
          'Air filter replacement',
          'Dust/pollen filter replacement',
          'Coolant replacement',
          'Brake fluid replacement',
          'Spark plugs replacement (if needed)',
          'Brake pads (front & rear) replacement (if needed)',
          'Brake discs (front & rear) replacement (if needed)'
        ],
        symptoms: [
          'High mileage since the last big service',
          'Harsh, noisy running or reduced performance',
          'Recently purchased vehicle with unknown history',
          'Planning a long trip and want everything refreshed'
        ]
      },
      {
        id: 'minor_service',
        title: 'Minor Service Package',
        price: 'From £110',
        applicable: ['Petrol', 'Diesel'],
        overview: 'Ideal between major visits to keep core fluids and filters in shape without the full overhaul.',
        includes: [
          'Engine oil replacement',
          'Oil filter replacement',
          'Air filter replacement',
          'Dust/pollen filter replacement',
          'Coolant replacement'
        ],
        symptoms: [
          'Due for an interim service based on mileage or time',
          'Noticeable drop in MPG or throttle response',
          'Mild engine noise or vibration starting to appear',
          'Want a mid-year refresh between major services'
        ]
      },
      {
        id: 'premium_service',
        title: 'Premium Service Package',
        price: 'From £300',
        applicable: ['Petrol', 'Diesel'],
        overview: 'Adds extra safety checks on top of the basics so you can drive away confident everything is in good health.',
        includes: [
          'Engine oil replacement',
          'Oil filter replacement',
          'Air filter replacement',
          'Dust/pollen filter replacement',
          'Coolant replacement',
          'Spark plugs replacement (if needed)',
          'Brake pads (front & rear) replacement (if needed)',
          'Brake discs (front & rear) replacement (if needed)',
          'Tyre pressure & tread inspection',
          'Headlights/rear lights inspection',
          'Battery inspection'
        ],
        symptoms: [
          'General tune-up needed before a road trip',
          'Inconsistent performance or poor MPG',
          'Car feels fine but you want peace of mind checks',
          'Mix of city and motorway driving putting extra strain on components'
        ]
      },
      {
        id: 'pre_mot',
        title: 'Pre-MOT Diagnosis & Repair',
        price: '£150',
        applicable: ['Petrol', 'Diesel'],
        overview: 'Beat the test with a full MOT-style inspection and fixes before you book the official slot.',
        includes: [
          'Carry out an MOT-style check on brakes, suspension, steering and emissions',
          'Plug in diagnostics to clear historic faults and find hidden issues',
          'Inspect lights, tyres, wipers and seatbelts for legal compliance',
          'Provide a repair plan or carry out minor fixes so you pass first time'
        ],
        symptoms: [
          'MOT due soon and unsure what might fail',
          'Known issues not yet resolved',
          'Previous MOT advisories you want sorted',
          'Want confidence before spending on the official test'
        ]
      },
      {
        id: 'seasonal',
        title: 'Seasonal Maintenance Package',
        price: 'From £150',
        applicable: ['Petrol', 'Diesel'],
        overview: 'Get ready for heatwaves or cold snaps with preventative checks that keep you moving whatever the weather.',
        includes: [
          'Battery check',
          'Brake inspection',
          'Tyre inspection and pressure adjustment',
          'Cooling system check',
          'Lights inspection'
        ],
        symptoms: [
          'Heading into winter or summer and want peace of mind',
          'Planning a long seasonal road trip',
          'Car struggles to start or fogs up in extreme weather',
          'Want to prevent weather-related breakdowns'
        ]
      },
      {
        id: 'tyre_check',
        title: 'Tyre Health Check',
        price: 'From £35',
        applicable: ['Petrol', 'Diesel'],
        overview: 'Keep tyres legal and even-wearing so you stay safe and avoid unnecessary replacements.',
        includes: [
          'Inspect tread depth across each tyre',
          'Check for cracks, punctures and sidewall damage',
          'Set pressures to the correct loaded settings',
          'Torque wheel nuts and inspect valves and caps'
        ],
        symptoms: [
          'Vehicle pulling to one side or vibrating at speed',
          'Uneven or rapid tyre wear patterns',
          'Visible cracks, bulges or embedded objects',
          'Just bought used tyres or haven\'t checked pressures in a while'
        ]
      },
      {
        id: 'wiper_motor',
        title: 'Window Wiper Motor Replacement',
        price: 'From £50',
        applicable: ['Petrol', 'Diesel'],
        overview: 'Reliable wipers mean clear screens in all weather, keeping you safe and legal.',
        includes: [
          'Test the wiper system to confirm a motor fault',
          'Remove the failed motor and inspect linkages',
          'Install the new motor and set the park position',
          'Lubricate pivots and verify smooth, synchronised operation'
        ],
        symptoms: [
          'Wipers slow down, stall or stop mid-sweep',
          'Arms move out of sync or judder across the glass',
          'Burning smell or noises from the scuttle area',
          'Wipers refuse to start even with a good fuse'
        ]
      },
      {
        id: 'ac',
        title: 'Air Conditioning Top-Up/Recharge',
        price: 'From £85',
        applicable: ['Petrol', 'Diesel'],
        overview: 'Fresh refrigerant keeps the cabin cool, clears mist quickly and protects the AC compressor.',
        includes: [
          'Recover any remaining refrigerant and measure what\'s left',
          'Vacuum-test the system to check for major leaks',
          'Recharge with the correct gas and compressor oil',
          'Check cabin vent temperatures and system pressures'
        ],
        symptoms: [
          'Weak or no cold air even with AC on',
          'Bad odours coming through the vents',
          'Windows taking ages to demist',
          'Groaning compressor or AC cycling rapidly'
        ]
      },
      {
        id: 'fuel_injector',
        title: 'Fuel Injector Replacement (includes Recoding)',
        price: 'From £150',
        applicable: ['Petrol', 'Diesel'],
        overview: 'Fresh injectors restore smooth running and we code them to the ECU so everything stays balanced.',
        includes: [
          'Test existing injectors to confirm the fault',
          'Remove and replace the affected injectors',
          'Code the new injectors to the ECU where required',
          'Balance idle trims and road-test the vehicle'
        ],
        symptoms: [
          'Rough idle or hard starting, especially when cold',
          'Misfires under load or poor acceleration',
          'Fuel smells from the exhaust or engine bay',
          'Poor MPG or excessive smoke'
        ]
      },
      {
        id: 'glow_plug',
        title: 'Glow Plug Replacement',
        price: 'From £50',
        applicable: ['Diesel'],
        overview: 'Healthy glow plugs are vital for quick diesel starts and a clean burn on cold mornings.',
        includes: [
          'Test glow plug resistance and the control module',
          'Remove tired plugs using specialist tools',
          'Install quality replacements with anti-seize applied',
          'Reset any related fault codes or warning lights'
        ],
        symptoms: [
          'Hard starting in cold weather',
          'White smoke on start-up that clears as the engine warms',
          'Rough running for the first few seconds',
          'Glow plug warning light staying on'
        ]
      },
      {
        id: 'spark_plug',
        title: 'Spark Plug Replacement',
        price: 'From £50',
        applicable: ['Petrol'],
        overview: 'Fresh plugs keep petrol engines smooth, efficient and easy to start.',
        includes: [
          'Remove old spark plugs and inspect their condition',
          'Check coil packs and leads for wear while accessible',
          'Install new correctly gapped spark plugs',
          'Torque to spec and verify smooth idle'
        ],
        symptoms: [
          'Misfires or rough running, especially under load',
          'Poor acceleration or sluggish throttle response',
          'Higher fuel consumption than normal',
          'Struggling to start or long cranking times'
        ]
      },
      {
        id: 'ignition',
        title: 'Ignition Coils / Leads Replacement',
        price: 'From £80',
        applicable: ['Petrol', 'Diesel'],
        overview: 'Strong spark and clean signals stop misfires, protect the catalytic converter and keep emissions low.',
        includes: [
          'Test coils and leads with diagnostic equipment',
          'Replace faulty components with high-quality parts',
          'Inspect wiring harnesses and connectors for damage',
          'Road-test and monitor live data to confirm the fix'
        ],
        symptoms: [
          'Engine misfire or juddering under acceleration',
          'Check engine light flashing or stored misfire codes',
          'Jerky throttle response or uneven idle',
          'Fuel smells from the exhaust or poor emissions results'
        ]
      },
      {
        id: 'handbrake',
        title: 'Handbrake Adjustment',
        price: 'From £150',
        applicable: ['Petrol', 'Diesel'],
        overview: 'A properly adjusted parking brake keeps the car secure on hills and ready for the MOT.',
        includes: [
          'Inspect cables, levers and mechanisms for wear',
          'Adjust the handbrake to the correct bite point',
          'Lubricate pivot points to prevent seizing',
          'Test hold on inclines and set the lever travel'
        ],
        symptoms: [
          'Handbrake pulls up too high before it grips',
          'Vehicle rolls on slopes even with the brake applied',
          'Poor MOT handbrake results or advisories',
          'Rear brakes feel weak or uneven'
        ]
      },
      {
        id: 'not_sure',
        title: "I'm not sure",
        price: 'Quote provided',
        applicable: ['Petrol', 'Diesel'],
        overview: 'Not certain what you need? Tell us what the vehicle is doing and we\'ll guide you towards the right repair or service package.',
        includes: [
          'Listen to your concerns and review the vehicle symptoms',
          'Recommend the most suitable service or repair before any work starts',
          'Provide an estimate for parts and labour once the issue is identified',
          'Keep you updated with transparent findings and next steps'
        ],
        symptoms: [
          'Warning lights or messages without a clear cause',
          'New noises, vibrations or handling changes',
          'Intermittent faults that are hard to pin down',
          'Any other issue where you just want expert advice first'
        ],
        notes: 'Use this option if you want us to investigate and advise on the best fix before committing to a service.',
        requiresDetails: true,
        extraField: {
          id: 'notSureDetails',
          label: 'Tell us what is happening',
          placeholder: 'Please explain the issue you are experiencing.'
        }
      }
    ];

    let vehicleDetails = null;

    async function fetchVehicleDetails(vrm) {
      let fallbackReason = null;
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ vrm }),
          cache: 'no-store'
        });

        let data = null;
        try {
          data = await response.json();
        } catch (parseError) {
          data = null;
        }

        if (!response.ok) {
          if (response.status >= 400 && response.status < 500) {
            const message = (response.status === 400 || response.status === 404)
              ? VEHICLE_NOT_FOUND_MESSAGE
              : resolveErrorMessage(data?.error) || resolveErrorMessage(data?.message);
            throw new Error(message || 'Lookup failed');
          }

          fallbackReason = `API responded with status ${response.status}`;
          const message = resolveErrorMessage(data?.error) || resolveErrorMessage(data?.message);
          throw new Error(message || 'Lookup failed');
        }

        return data || {};
      } catch (err) {
        if (!fallbackReason && !(err instanceof TypeError)) {
          throw err;
        }

        const fallbackResponse = await fetch(DVLA_FALLBACK_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': DVLA_FALLBACK_KEY
          },
          body: JSON.stringify({ registrationNumber: vrm }),
          mode: 'cors',
          cache: 'no-store'
        });

        let fallbackData = null;
        try {
          fallbackData = await fallbackResponse.json();
        } catch (parseError) {
          fallbackData = null;
        }

        if (!fallbackResponse.ok) {
          const message = (fallbackResponse.status === 400 || fallbackResponse.status === 404)
            ? VEHICLE_NOT_FOUND_MESSAGE
            : resolveErrorMessage(fallbackData?.message) || resolveErrorMessage(fallbackData?.error);
          throw new Error(message || 'Lookup failed');
        }

        return fallbackData || {};
      }
    }

    function normaliseFuel(fuel) {
      const value = (fuel || '').toUpperCase();
      if (value.includes('ELECTRIC')) return 'Electric';
      if (value.includes('DIESEL')) return 'Diesel';
      if (value.includes('PETROL')) return 'Petrol';
      if (value.includes('HYBRID')) {
        return value.includes('DIESEL') ? 'Diesel' : 'Petrol';
      }
      return 'Both';
    }

    function renderVehicle(data, vrm) {
      vehicleDetails = data;
      const title = [data.make, data.model].filter(Boolean).join(' ');
      document.getElementById('vehTitle').textContent = title || 'Vehicle details';
      const engine = data.engineCapacity ? `${(data.engineCapacity/1000).toFixed(1)}L` : '';
      const metaBits = [data.fuelType, engine, data.colour].filter(Boolean).join(' • ');
      document.getElementById('vehMeta').textContent = metaBits;
      document.getElementById('vehReg').textContent = `Reg: ${vrm}`;

      // MOT
      const motStatus = document.getElementById('motStatus');
      if (data.motExpiryDate) {
        const motDate = new Date(data.motExpiryDate);
        const days = Math.round((motDate - new Date()) / 86400000);
        const dayText = isNaN(days) ? '' : ` (${days} days left)`;
        motStatus.textContent = `${motDate.toLocaleDateString('en-GB')}${dayText}`;
      } else {
        motStatus.textContent = 'Unknown';
      }

      // Tax
      const taxStatus = document.getElementById('taxStatus');
      taxStatus.textContent = (data.taxStatus || 'Unknown');

      const evNotice = document.getElementById('evNotice');
      if (normaliseFuel(data.fuelType) === 'Electric') {
        evNotice.textContent = 'We do not do electric just yet but we are hoping to expand to them soon.';
        evNotice.classList.remove('hidden');
      } else {
        evNotice.classList.add('hidden');
        evNotice.textContent = '';
      }

      document.getElementById('vehicleCard').classList.remove('hidden');
    }

    function renderServices(data) {
      const messageBox = document.getElementById('servicesMessage');
      const listBox = document.getElementById('serviceList');
      const warranty = document.getElementById('warrantySection');
      const finish = document.getElementById('finishContainer');

      listBox.innerHTML = '';
      resetCustomerForm();
      refreshDateLimits();

      if (DATE_INPUT) {
        DATE_INPUT.value = '';
      }
      if (TIME_INPUT) {
        TIME_INPUT.value = '';
      }
      setModeSelection('', { expand: false });
      if (FULFILMENT_SECTION) {
        FULFILMENT_SECTION.classList.add('hidden');
      }
      if (BOOKING_SECTION) {
        BOOKING_SECTION.classList.add('hidden');
      }

      const fuel = normaliseFuel(data.fuelType);
      if (fuel === 'Electric') {
        messageBox.textContent = 'We do not do electric just yet but we are hoping to expand to them soon. Please check back later!';
        messageBox.classList.remove('hidden');
        warranty.classList.add('hidden');
        if (FULFILMENT_SECTION) {
          FULFILMENT_SECTION.classList.add('hidden');
        }
        if (BOOKING_SECTION) {
          BOOKING_SECTION.classList.add('hidden');
        }
        finish.classList.add('hidden');
        return;
      }

      warranty.querySelectorAll('input[name="warr"]').forEach((input, index) => {
        input.checked = index === 0;
      });

      warranty.classList.add('hidden');
      finish.classList.add('hidden');

      const available = SERVICES.filter(service =>
        fuel === 'Both' || service.applicable.length === 2 || service.applicable.includes(fuel)
      );

      if (available.length === 0) {
        messageBox.textContent = 'No services available for this vehicle type just yet — please contact us for help.';
        messageBox.classList.remove('hidden');
        warranty.classList.add('hidden');
        if (FULFILMENT_SECTION) {
          FULFILMENT_SECTION.classList.add('hidden');
        }
        if (BOOKING_SECTION) {
          BOOKING_SECTION.classList.add('hidden');
        }
        finish.classList.add('hidden');
        return;
      }

      const typeText = fuel === 'Both' ? 'petrol and diesel vehicles' : `${fuel.toLowerCase()} vehicles`;
      messageBox.textContent = `Tap a service to reveal what's included for ${typeText}.`;
      messageBox.classList.remove('hidden');

      const serviceMarkup = available.map(service => {
        const suitabilityTag = service.applicable.length === 2 ? '' : `${service.applicable[0]} only`;
        const suitabilityText = service.suitability || (service.applicable.length === 2
          ? 'Suitable for petrol and diesel vehicles.'
          : service.applicable[0] === 'Petrol'
            ? 'Suitable for petrol vehicles only.'
            : 'Suitable for diesel vehicles only.'
        );
        const includesHtml = service.includes && service.includes.length
          ? `<div class="service-section"><h4>What's included</h4><ul>${service.includes.map(item => `<li>${item}</li>`).join('')}</ul></div>`
          : '';
        const symptomsHtml = service.symptoms && service.symptoms.length
          ? `<div class="service-section"><h4>When to book</h4><ul>${service.symptoms.map(item => `<li>${item}</li>`).join('')}</ul></div>`
          : '';
        const notesHtml = service.notes ? `<p class="service-note">${service.notes}</p>` : '';
        const extraHtml = service.extraField
          ? `<div class="service-section"><h4>${service.extraField.label}</h4><textarea id="${service.extraField.id}" name="${service.extraField.id}" rows="4" placeholder="${service.extraField.placeholder}" data-service-extra="${service.id}"></textarea></div>`
          : '';

        return `
          <label class="service-item" data-service="${service.id}">
            <div class="service-summary">
              <div>
                <h3>${service.title}</h3>
                <div class="service-meta">
                  <span class="price">${service.price}</span>
                  ${suitabilityTag ? `<span class="applicable-tag">${suitabilityTag}</span>` : ''}
                </div>
              </div>
              <div class="service-controls">
                <span class="chevron" aria-hidden="true">&#9662;</span>
                <input type="radio" class="service-radio" name="srv" value="${service.id}" data-title="${service.title}" data-price="${service.price}" data-require-details="${service.requiresDetails ? 'true' : 'false'}" data-extra-field-id="${service.extraField ? service.extraField.id : ''}">
              </div>
            </div>
            <div class="service-body">
              <p class="service-overview">${service.overview}</p>
              <p class="service-suitability">${suitabilityText}</p>
              ${includesHtml}
              ${notesHtml}
              ${symptomsHtml}
              ${extraHtml}
            </div>
          </label>
        `;
      }).join('');

      listBox.innerHTML = serviceMarkup;

      const serviceItems = Array.from(listBox.querySelectorAll('.service-item'));
      serviceItems.forEach(item => {
        const radio = item.querySelector('input[name="srv"]');
        const expand = () => {
          serviceItems.forEach(other => other.classList.remove('expanded'));
          item.classList.add('expanded');
          radio.checked = true;
          warranty.classList.remove('hidden');
          if (FULFILMENT_SECTION) {
            FULFILMENT_SECTION.classList.remove('hidden');
          }
          if (BOOKING_SECTION) {
            BOOKING_SECTION.classList.remove('hidden');
          }
          if (INFO_SECTION) {
            INFO_SECTION.classList.remove('hidden');
          }
          if (DATE_INPUT && !DATE_INPUT.value) {
            refreshDateLimits();
            DATE_INPUT.value = DATE_INPUT.min;
          }
          if (TIME_INPUT && !TIME_INPUT.value) {
            TIME_INPUT.value = '09:00';
          }
          finish.classList.remove('hidden');
        };

        item.addEventListener('click', event => {
          if (event.target.tagName === 'A') {
            return;
          }
          expand();
        });

        radio.addEventListener('change', () => {
          if (radio.checked) {
            expand();
          }
        });
      });

      document.getElementById('servicesCard').classList.remove('hidden');
    }

    async function lookupVRM() {
      const input = document.getElementById('vrm');
      const vrm = (input.value || '').toUpperCase().replace(/\s+/g, '');
      const errorBox = document.getElementById('error');
      errorBox.classList.add('hidden');
      errorBox.textContent = '';

      if (vrm.length < 5) {
        errorBox.textContent = 'Please enter a valid registration (at least 5 characters).';
        errorBox.classList.remove('hidden');
        return;
      }

      const button = document.getElementById('lookupBtn');
      button.disabled = true;
      button.textContent = 'Looking…';

      try {
        const data = await fetchVehicleDetails(vrm);
        renderVehicle(data, vrm);
        renderServices(data);
      } catch (err) {
        let message = '';
        if (err && typeof err.message === 'string') {
          message = err.message;
        } else if (typeof err === 'string') {
          message = err;
        }

        if (!message || message === '[object Object]' || message === 'Lookup failed') {
          message = VEHICLE_NOT_FOUND_MESSAGE;
        }

        errorBox.textContent = message || 'Something went wrong while looking up the registration.';
        errorBox.classList.remove('hidden');
      } finally {
        button.disabled = false;
        button.textContent = 'Look up';
      }
    }

    function finishBooking() {
      const serviceInput = document.querySelector('input[name="srv"]:checked');
      if (!serviceInput) {
        alert('Please pick a service.');
        return;
      }

      const requiresDetails = serviceInput.dataset.requireDetails === 'true';
      const extraFieldId = serviceInput.dataset.extraFieldId;
      let serviceDetails = '';
      if (extraFieldId) {
        const extraField = document.getElementById(extraFieldId);
        if (extraField) {
          serviceDetails = extraField.value.trim();
        }
      }
      if (requiresDetails && !serviceDetails) {
        alert('Please explain the issue you are experiencing so we can help.');
        return;
      }

      const modeInput = document.querySelector('input[name="mode"]:checked');
      let modeLabel = '';
      let modeKey = '';

      if (modeInput) {
        modeLabel = modeInput.dataset.label || modeInput.value;
        modeKey = modeInput.closest('.mode-item')?.dataset.mode || '';
      } else if (MODE_SELECT && MODE_SELECT.value) {
        const option = MODE_SELECT.selectedOptions[0];
        const optionValue = MODE_SELECT.value;
        modeLabel = option?.dataset.label || option?.textContent?.trim() || optionValue;
        modeKey = optionValue;
        if (optionValue) {
          setModeSelection(optionValue, { expand: true });
        }
      }

      if (!modeLabel) {
        alert('Please choose whether you would like a mobile mechanic or to drop the vehicle at the garage.');
        return;
      }

      if (!modeKey) {
        modeKey = MODE_SELECT?.value || '';
      }

      refreshDateLimits();

      if (!DATE_INPUT || !DATE_INPUT.value) {
        alert('Please pick an appointment date from today onwards.');
        return;
      }

      if (DATE_INPUT.value < DATE_INPUT.min) {
        alert('Please choose a date from today onwards.');
        return;
      }

      if (!TIME_INPUT || !TIME_INPUT.value || !ALLOWED_TIMES.includes(TIME_INPUT.value)) {
        alert('Please choose an appointment between 09:00 and 17:00 in 30-minute steps.');
        return;
      }

      const dateParts = DATE_INPUT.value.split('-');
      const formattedDate = dateParts.length === 3 ? `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}` : DATE_INPUT.value;
      const formattedTime = TIME_INPUT.value ? TIME_INPUT.value.slice(0, 5) : '';

      const firstName = FIRST_NAME_INPUT ? FIRST_NAME_INPUT.value.trim() : '';
      if (!firstName) {
        alert('Please enter your first name.');
        return;
      }

      const lastName = LAST_NAME_INPUT ? LAST_NAME_INPUT.value.trim() : '';
      if (!lastName) {
        alert('Please enter your last name.');
        return;
      }

      const email = EMAIL_INPUT ? EMAIL_INPUT.value.trim() : '';
      if (!email) {
        alert('Please provide your email address so we can get back to you.');
        return;
      }
      const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailPattern.test(email)) {
        alert('Please enter a valid email address.');
        return;
      }

      const phone = PHONE_INPUT ? PHONE_INPUT.value.trim() : '';
      if (!phone) {
        alert('Please enter your phone number.');
        return;
      }

      let serviceAddress = '';
      if (modeKey === 'mobile') {
        const addressLine1 = SERVICE_ADDRESS_LINE1_INPUT ? SERVICE_ADDRESS_LINE1_INPUT.value.trim() : '';
        const addressLine2 = SERVICE_ADDRESS_LINE2_INPUT ? SERVICE_ADDRESS_LINE2_INPUT.value.trim() : '';
        const city = SERVICE_CITY_INPUT ? SERVICE_CITY_INPUT.value.trim() : '';
        const postcodeRaw = SERVICE_POSTCODE_INPUT ? SERVICE_POSTCODE_INPUT.value.trim() : '';
        const postcode = postcodeRaw ? postcodeRaw.toUpperCase() : '';

        if (!addressLine1) {
          alert('Please enter the street address for the mobile booking.');
          return;
        }
        if (!city) {
          alert('Please enter the city for the mobile booking.');
          return;
        }
        if (!postcode) {
          alert('Please enter the postcode for the mobile booking.');
          return;
        }

        if (SERVICE_ADDRESS_LINE1_INPUT) SERVICE_ADDRESS_LINE1_INPUT.value = addressLine1;
        if (SERVICE_ADDRESS_LINE2_INPUT) SERVICE_ADDRESS_LINE2_INPUT.value = addressLine2;
        if (SERVICE_CITY_INPUT) SERVICE_CITY_INPUT.value = city;
        if (SERVICE_POSTCODE_INPUT) SERVICE_POSTCODE_INPUT.value = postcode;

        const cityPostcode = [city, postcode].filter(Boolean).join(' ');
        serviceAddress = [addressLine1, addressLine2, cityPostcode].filter(Boolean).join(', ');
      }

      const extraComments = EXTRA_COMMENTS_INPUT ? EXTRA_COMMENTS_INPUT.value.trim() : '';
      const warrantyInput = document.querySelector('input[name="warr"]:checked');

      const customerDetails = [
        `Customer name: ${firstName} ${lastName}`,
        `Customer email: ${email}`,
        `Customer phone: ${phone}`,
        modeKey === 'mobile' ? `Service address: ${serviceAddress}` : '',
        modeKey === 'garage' ? `Drop-off location: ${GARAGE_ADDRESS_TEXT}` : '',
        extraComments ? `Extra comments: ${extraComments}` : ''
      ].filter(Boolean).join('\\n');

      const bookingDetails = [
        `Vehicle: ${document.getElementById('vehTitle').textContent}`,
        document.getElementById('vehMeta').textContent ? `Details: ${document.getElementById('vehMeta').textContent}` : '',
        document.getElementById('vehReg').textContent,
        `MOT: ${document.getElementById('motStatus').textContent}`,
        `Tax: ${document.getElementById('taxStatus').textContent}`,
        `Service: ${serviceInput.dataset.title} (${serviceInput.dataset.price})`,
        serviceDetails ? `Service notes: ${serviceDetails}` : '',
        warrantyInput ? `Warranty: ${warrantyInput.value}` : '',
        `Service mode: ${modeLabel}`,
        `Preferred appointment: ${formattedDate} at ${formattedTime}`
      ].filter(Boolean).join('\\n');

      const details = [customerDetails, bookingDetails].filter(Boolean).join('\\n\\n');

      const subject = encodeURIComponent('Service Booking Request');
      const body = encodeURIComponent(`${details}\\n\\nPlease contact me to confirm availability.`);
      window.location.href = `mailto:support@mitchsautoservices.co.uk?subject=${subject}&body=${body}`;
    }

    window.lookupVRM = lookupVRM;
    window.finishBooking = finishBooking;
  </script>
</body>
</html>
